<!DOCTYPE html>
<html lang="hu"> <!-- Magyar nyelv. -->
<head> <!-- Head. -->
  <meta charset="UTF-8" /> <!-- UTF-8. -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- Reszponz√≠v. -->
  <title>Fot√≥-n√©zeget≈ë (FIX: map adat nem cs√∫szik el)</title> <!-- C√≠m. -->

  <link rel="preconnect" href="https://fonts.googleapis.com" /> <!-- Font gyors√≠t√°s. -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /> <!-- Font gyors√≠t√°s. -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" /> <!-- Inter. -->

  <script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/lite.umd.js"></script> <!-- EXIF olvas√≥. -->

  <style> /* CSS. */
    :root { /* V√°ltoz√≥k. */
      --bg0: #070a10; /* H√°tt√©r. */
      --txt: #e8edf6; /* Sz√∂veg. */
      --muted: #a9b4c7; /* Halv√°ny. */
      --accent: #7c5cff; /* Akcent. */
      --ok: #2dd4bf; /* Akcent 2. */
      --radius: 22px; /* Lekerek√≠t√©s. */
      --shadow: 0 24px 80px rgba(0,0,0,.55); /* √Årny√©k. */
      --pad: 18px; /* Viewer padding. */
      --metaH: 76px; /* Meta c√©lmagass√°g (dinamikusan friss√ºl). */
      --framePad: 10px; /* Sz√≠nes keret vastags√°g. */
      --innerPad: 10px; /* Bels≈ë padding. */
      --imgRadius: 18px; /* K√©p lekerek√≠t√©s. */
      --maxW: 1200px; /* Max sz√©less√©g. */
    } /* root v√©ge. */

    * { box-sizing: border-box; } /* M√©retez√©s. */
    html, body { height: 100%; } /* Teljes magass√°g. */

    body { /* Alap h√°tt√©r. */
      margin: 0; /* Marg√≥ 0. */
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; /* Font. */
      color: var(--txt); /* Sz√≠n. */
      background:
        radial-gradient(1200px 800px at 30% 20%, rgba(124,92,255,.22), transparent 55%),
        radial-gradient(1000px 700px at 75% 65%, rgba(45,212,191,.16), transparent 60%),
        linear-gradient(180deg, var(--bg0), #020308 70%); /* H√°tt√©r. */
    } /* body v√©ge. */

    #setup { /* Setup n√©zet. */
      min-height: 100vh; /* Teljes magass√°g. */
      display: grid; /* K√∂z√©pre. */
      place-items: center; /* K√∂z√©pre. */
      padding: 18px; /* T√©r. */
    } /* setup v√©ge. */

    .setupCard { /* Setup k√°rtya. */
      width: min(980px, 100%); /* Sz√©less√©g. */
      background: rgba(255,255,255,.06); /* √úveg. */
      border: 1px solid rgba(255,255,255,.12); /* Keret. */
      border-radius: calc(var(--radius) + 6px); /* Lekerek√≠t√©s. */
      box-shadow: var(--shadow); /* √Årny√©k. */
      overflow: hidden; /* V√°g√°s. */
    } /* setupCard v√©ge. */

    .setupTop { /* Setup header. */
      padding: 18px 18px 10px; /* T√©r. */
      display: flex; /* Flex. */
      align-items: center; /* K√∂z√©p. */
      justify-content: space-between; /* Sz√©t. */
      gap: 10px; /* T√©r. */
      flex-wrap: wrap; /* T√∂rdel√©s. */
    } /* setupTop v√©ge. */

    .brand { /* Brand. */
      display: flex; /* Flex. */
      gap: 10px; /* T√©r. */
      align-items: center; /* K√∂z√©p. */
    } /* brand v√©ge. */

    .dot { /* P√∂tty. */
      width: 12px; /* Sz√©less√©g. */
      height: 12px; /* Magass√°g. */
      border-radius: 999px; /* K√∂r. */
      background: linear-gradient(135deg, var(--accent), var(--ok)); /* Gradiens. */
      box-shadow: 0 0 18px rgba(124,92,255,.42); /* F√©ny. */
      flex: 0 0 auto; /* Fix. */
    } /* dot v√©ge. */

    .title { /* C√≠m. */
      font-weight: 800; /* Vastag. */
      font-size: 16px; /* M√©ret. */
      letter-spacing: .2px; /* Spacing. */
    } /* title v√©ge. */

    .subtitle { /* Alc√≠m. */
      margin-top: 2px; /* T√©r. */
      font-size: 12px; /* M√©ret. */
      color: var(--muted); /* Halv√°ny. */
      line-height: 1.45; /* Sork√∂z. */
    } /* subtitle v√©ge. */

    .pillRow { /* Pill sor. */
      display: flex; /* Flex. */
      gap: 10px; /* T√©r. */
      align-items: center; /* K√∂z√©p. */
      flex-wrap: wrap; /* T√∂rdel. */
      justify-content: flex-end; /* Jobbra. */
    } /* pillRow v√©ge. */

    .pill { /* Pill. */
      padding: 7px 10px; /* T√©r. */
      border-radius: 999px; /* Kapszula. */
      background: rgba(0,0,0,.20); /* H√°tt√©r. */
      border: 1px solid rgba(255,255,255,.12); /* Keret. */
      color: var(--muted); /* Sz√≠n. */
      font-size: 12px; /* M√©ret. */
      user-select: none; /* Ne jel√∂lj√∂n. */
    } /* pill v√©ge. */

    .pill b { color: var(--txt); } /* Kiemel√©s. */

    .setupBody { /* Setup body. */
      padding: 0 18px 18px; /* T√©r. */
      display: grid; /* R√°cs. */
      gap: 12px; /* T√©r. */
    } /* setupBody v√©ge. */

    .row { /* Sor. */
      display: flex; /* Flex. */
      gap: 10px; /* T√©r. */
      flex-wrap: wrap; /* T√∂rdel. */
      align-items: center; /* K√∂z√©p. */
    } /* row v√©ge. */

    .btn { /* Gomb. */
      appearance: none; /* Nat√≠v off. */
      border: 1px solid rgba(255,255,255,.14); /* Keret. */
      background: rgba(255,255,255,.08); /* √úveg. */
      color: var(--txt); /* Sz√≠n. */
      padding: 10px 14px; /* T√©r. */
      border-radius: 14px; /* Lekerek√≠t√©s. */
      cursor: pointer; /* Mutat√≥. */
      font-weight: 600; /* Vastag. */
      transition: transform .08s ease, background .2s ease, border-color .2s ease; /* Anim. */
      user-select: none; /* Ne jel√∂lj√∂n. */
    } /* btn v√©ge. */

    .btn:hover { /* Hover. */
      background: rgba(255,255,255,.12); /* Er≈ësebb. */
      border-color: rgba(255,255,255,.22); /* Er≈ësebb. */
    } /* hover v√©ge. */

    .btn:active { transform: translateY(1px); } /* Press. */

    .btn.primary { /* Primary. */
      border: 1px solid rgba(124,92,255,.45); /* Keret. */
      background: linear-gradient(135deg, rgba(124,92,255,.33), rgba(45,212,191,.18)); /* Gradiens. */
    } /* primary v√©ge. */

    .btn.danger { /* Danger. */
      border: 1px solid rgba(251,113,133,.40); /* Keret. */
      background: rgba(251,113,133,.10); /* H√°tt√©r. */
    } /* danger v√©ge. */

    .hint { /* Hint. */
      color: var(--muted); /* Halv√°ny. */
      font-size: 12px; /* M√©ret. */
      line-height: 1.45; /* Sork√∂z. */
    } /* hint v√©ge. */

    .log { /* Log. */
      background: rgba(0,0,0,.22); /* H√°tt√©r. */
      border: 1px solid rgba(255,255,255,.10); /* Keret. */
      border-radius: 16px; /* Lekerek√≠t√©s. */
      padding: 12px; /* T√©r. */
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; /* Monospace. */
      font-size: 12px; /* M√©ret. */
      color: #d9e2f5; /* Sz√≠n. */
      white-space: pre-wrap; /* T√∂rdel√©s. */
      max-height: 170px; /* Limit. */
      overflow: auto; /* Scroll. */
    } /* log v√©ge. */

    .kbd { /* KBD. */
      font-size: 11px; /* M√©ret. */
      color: var(--muted); /* Halv√°ny. */
      padding: 7px 10px; /* T√©r. */
      border: 1px solid rgba(255,255,255,.12); /* Keret. */
      border-radius: 999px; /* Kapszula. */
      background: rgba(255,255,255,.06); /* √úveg. */
      user-select: none; /* Ne jel√∂lj√∂n. */
    } /* kbd v√©ge. */

    #viewer { /* Viewer. */
      position: fixed; /* Fix. */
      inset: 0; /* Teljes. */
      display: none; /* Rejtve. */
      padding: var(--pad); /* Padding. */
      overflow: auto; /* Scroll biztons√°g. */
      -webkit-overflow-scrolling: touch; /* Mobil. */
    } /* viewer v√©ge. */

    .stage { /* Sz√≠npad. */
      width: min(var(--maxW), 100%); /* Sz√©less√©g. */
      margin: 0 auto; /* K√∂z√©p. */
      display: grid; /* R√°cs. */
      gap: 10px; /* T√©r. */
      grid-template-rows: auto auto; /* K√©p + meta. */
      align-items: center; /* K√∂z√©p. */
      justify-items: center; /* K√∂z√©p. */
      min-height: calc(100dvh - (2 * var(--pad))); /* Min. */
    } /* stage v√©ge. */

    .frame { /* IG keret. */
      width: 100%; /* Teljes. */
      border-radius: calc(var(--radius) + 10px); /* Lekerek√≠t√©s. */
      padding: var(--framePad); /* Keret. */
      background: linear-gradient(135deg, #f58529, #dd2a7b, #8134af, #515bd4); /* Gradiens. */
      box-shadow: var(--shadow); /* √Årny√©k. */
      display: grid; /* Grid. */
      place-items: center; /* K√∂z√©p. */
    } /* frame v√©ge. */

    .inner { /* Bels≈ë. */
      width: 100%; /* Teljes. */
      border-radius: var(--radius); /* Lekerek√≠t√©s. */
      background: rgba(10,14,22,.92); /* S√∂t√©t. */
      border: 1px solid rgba(255,255,255,.12); /* Keret. */
      padding: var(--innerPad); /* Padding. */
      display: grid; /* Grid. */
      place-items: center; /* K√∂z√©p. */
    } /* inner v√©ge. */

    img#photo { /* K√©p. */
      width: auto; /* Auto. */
      height: auto; /* Auto. */
      max-width: 100%; /* Sz√©less√©g limit. */
      max-height: calc(100dvh - (2 * var(--pad)) - var(--metaH) - (2 * var(--framePad)) - (2 * var(--innerPad)) - 22px); /* Magass√°g limit. */
      object-fit: contain; /* Ar√°nytart√≥. */
      border-radius: var(--imgRadius); /* Lekerek√≠t√©s. */
      background: rgba(0,0,0,.18); /* H√°tt√©r. */
      display: block; /* Block. */
    } /* img v√©ge. */

    .metaBar { /* Meta s√°v. */
      width: 100%; /* Teljes. */
      display: flex; /* Flex. */
      align-items: center; /* K√∂z√©p. */
      justify-content: space-between; /* Sz√©t. */
      gap: 10px; /* T√©r. */
      flex-wrap: wrap; /* T√∂rdel. */
      padding: 10px 12px; /* T√©r. */
      border-radius: 16px; /* Lekerek√≠t√©s. */
      background: rgba(0,0,0,.30); /* √úveg. */
      border: 1px solid rgba(255,255,255,.12); /* Keret. */
      backdrop-filter: blur(10px); /* Blur. */
      min-height: var(--metaH); /* Minimum. */
    } /* metaBar v√©ge. */

    .metaLeft { /* Bal meta. */
      display: grid; /* Sorok. */
      gap: 2px; /* T√©r. */
      min-width: 240px; /* Min. */
    } /* metaLeft v√©ge. */

    .metaLine { /* Sor. */
      font-size: 12px; /* M√©ret. */
      color: rgba(233,238,248,.86); /* Sz√≠n. */
      line-height: 1.35; /* Sork√∂z. */
      word-break: break-word; /* T√∂r√©s. */
    } /* metaLine v√©ge. */

    .metaLine b { /* Kiemel√©s. */
      color: var(--txt); /* Sz√≠n. */
      font-weight: 800; /* Vastag. */
    } /* b v√©ge. */

    .metaLine a { /* Link. */
      color: #cfe7ff; /* K√©k. */
      text-decoration: none; /* Nincs. */
      border-bottom: 1px dashed rgba(207,231,255,.45); /* Jelz√©s. */
    } /* a v√©ge. */

    .metaLine a:hover { border-bottom-color: rgba(207,231,255,.85); } /* Hover. */

    .nav { /* Nav. */
      display: flex; /* Flex. */
      gap: 8px; /* T√©r. */
      align-items: center; /* K√∂z√©p. */
      flex: 0 0 auto; /* Fix. */
    } /* nav v√©ge. */

    .exitHint { /* Tipp. */
      position: fixed; /* Fix. */
      right: 14px; /* Jobb. */
      bottom: 12px; /* Als√≥. */
      padding: 8px 10px; /* T√©r. */
      border-radius: 999px; /* Kapszula. */
      background: rgba(0,0,0,.25); /* √úveg. */
      border: 1px solid rgba(255,255,255,.10); /* Keret. */
      color: rgba(233,238,248,.70); /* Halv√°ny. */
      font-size: 11px; /* M√©ret. */
      user-select: none; /* Ne jel√∂lj√∂n. */
      pointer-events: none; /* Ne zavarjon. */
    } /* exitHint v√©ge. */

    @media (max-width: 680px) { /* Mobil. */
      :root { --metaH: 90px; } /* T√∂bb sor. */
    } /* media v√©ge. */
  </style> <!-- CSS v√©ge. -->
</head> <!-- Head v√©ge. -->
<body> <!-- Body. -->

  <section id="setup"> <!-- Setup. -->
    <div class="setupCard"> <!-- K√°rtya. -->
      <div class="setupTop"> <!-- Header. -->
        <div class="brand"> <!-- Brand. -->
          <div class="dot"></div> <!-- Dot. -->
          <div> <!-- Sz√∂veg. -->
            <div class="title">Fot√≥-n√©zeget≈ë</div> <!-- C√≠m. -->
            <div class="subtitle">FIX: a t√©rk√©padat <b>nem cs√∫szik el</b>, mindig csak az aktu√°lis k√©p √≠rhatja ki a helyet.</div> <!-- Alc√≠m. -->
          </div> <!-- Sz√∂veg v√©ge. -->
        </div> <!-- Brand v√©ge. -->
        <div class="pillRow"> <!-- St√°tusz. -->
          <div class="pill">K√©pek: <b id="count">0</b></div> <!-- Darab. -->
          <div class="pill">Aktu√°lis: <b id="index">-</b></div> <!-- Index. -->
          <div class="pill">Helyn√©v: <b id="geoState">-</b></div> <!-- Geo. -->
        </div> <!-- pillRow v√©ge. -->
      </div> <!-- setupTop v√©ge. -->

      <div class="setupBody"> <!-- Body. -->
        <div class="row"> <!-- Gombok. -->
          <button class="btn primary" id="btnPick">üìÅ Mappa kiv√°laszt√°sa</button> <!-- Pick. -->
          <button class="btn" id="btnStart" disabled>‚ñ∂ Megjelen√≠t√©s</button> <!-- Start. -->
          <button class="btn danger" id="btnReset" disabled>‚ü≤ Reset</button> <!-- Reset. -->
          <span class="kbd">‚Üê/‚Üí ‚Ä¢ Space/Enter ‚Ä¢ katt = k√∂v ‚Ä¢ Esc = vissza</span> <!-- Hint. -->
        </div> <!-- row v√©ge. -->

        <div class="hint"> <!-- Hint. -->
          A telep√ºl√©sn√©vhez reverse geocode fut (OpenStreetMap Nominatim). Ha nem kell: <b>BEALLITAS.reverseGeocode = false</b>. <!-- Hint. -->
        </div> <!-- hint v√©ge. -->

        <input id="fallbackFolder" type="file" webkitdirectory multiple accept="image/jpeg" style="display:none" /> <!-- Fallback. -->
        <div class="log" id="log">K√©szen √°llok. V√°lassz egy mapp√°t JPG k√©pekkel.</div> <!-- Log. -->
      </div> <!-- setupBody v√©ge. -->
    </div> <!-- setupCard v√©ge. -->
  </section> <!-- setup v√©ge. -->

  <section id="viewer"> <!-- Viewer. -->
    <div class="stage"> <!-- Stage. -->
      <div class="frame"> <!-- Frame. -->
        <div class="inner" id="imageWrap"> <!-- Katt. -->
          <img id="photo" alt="Kiv√°lasztott fot√≥" /> <!-- K√©p. -->
        </div> <!-- inner v√©ge. -->
      </div> <!-- frame v√©ge. -->

      <div class="metaBar" id="metaBar"> <!-- Meta. -->
        <div class="metaLeft"> <!-- Bal meta. -->
          <div class="metaLine">üìÑ <b id="fileName">-</b></div> <!-- N√©v. -->
          <div class="metaLine">üïí K√©sz√ºlt: <b id="takenAt">-</b></div> <!-- D√°tum. -->
          <div class="metaLine">üìç Hely: <span id="place">-</span></div> <!-- Hely. -->
        </div> <!-- metaLeft v√©ge. -->
        <div class="nav"> <!-- Nav. -->
          <button class="btn" id="btnPrev" disabled>‚Üê</button> <!-- Prev. -->
          <button class="btn" id="btnNext" disabled>‚Üí</button> <!-- Next. -->
        </div> <!-- nav v√©ge. -->
      </div> <!-- metaBar v√©ge. -->
    </div> <!-- stage v√©ge. -->
    <div class="exitHint">Esc = vissza ‚Ä¢ katt/space/enter = k√∂v ‚Ä¢ ‚Üê/‚Üí = nav</div> <!-- Tipp. -->
  </section> <!-- viewer v√©ge. -->

  <script> // JS. //
    "use strict"; // Strict. //

    const BEALLITAS = { // Konfig. //
      reverseGeocode: true, // Helyn√©v lek√©r√©s. //
      sortByName: true // Rendez√©s. //
    }; // Konfig v√©ge. //

    const elCount = document.getElementById("count"); // K√©psz√°m. //
    const elIndex = document.getElementById("index"); // Index. //
    const elGeoState = document.getElementById("geoState"); // Geo √°llapot. //
    const elLog = document.getElementById("log"); // Log. //

    const setup = document.getElementById("setup"); // Setup. //
    const viewer = document.getElementById("viewer"); // Viewer. //
    const metaBar = document.getElementById("metaBar"); // MetaBar. //

    const btnPick = document.getElementById("btnPick"); // Pick. //
    const btnStart = document.getElementById("btnStart"); // Start. //
    const btnReset = document.getElementById("btnReset"); // Reset. //
    const btnPrev = document.getElementById("btnPrev"); // Prev. //
    const btnNext = document.getElementById("btnNext"); // Next. //

    const fallbackFolder = document.getElementById("fallbackFolder"); // Fallback. //
    const imageWrap = document.getElementById("imageWrap"); // Katt ter√ºlet. //
    const imgPhoto = document.getElementById("photo"); // K√©p. //

    const elFileName = document.getElementById("fileName"); // F√°jln√©v. //
    const elTakenAt = document.getElementById("takenAt"); // D√°tum. //
    const elPlace = document.getElementById("place"); // Hely. //

    let files = []; // F√°jl lista. //
    let currentIndex = 0; // Index. //
    let currentObjectUrl = null; // Object URL. //

    let activeViewToken = 0; // <<< EZ A L√âNYEG: minden showImage kap egy token-t >>> //
    let activeGeoAbort = null; // <<< Ez abortolja a fut√≥ geocode-ot >>> //

    function log(msg) { // Log. //
      const ts = new Date().toLocaleTimeString(); // Id≈ë. //
      elLog.textContent = `[${ts}] ${msg}\n` + elLog.textContent; // El√∂lre. //
    } // log v√©ge. //

    function setCounts() { // UI. //
      elCount.textContent = String(files.length); // Darab. //
      elIndex.textContent = files.length ? `${currentIndex + 1}/${files.length}` : "-"; // Index. //
    } // setCounts v√©ge. //

    function safeReleaseObjectUrl() { // URL felszabad√≠t√°s. //
      if (currentObjectUrl) { URL.revokeObjectURL(currentObjectUrl); currentObjectUrl = null; } // Revoke. //
    } // safeReleaseObjectUrl v√©ge. //

    function isJpgFile(file) { // JPG check. //
      const nameOk = /\.jpe?g$/i.test(file.name); // Ext. //
      const typeOk = (file.type === "image/jpeg" || file.type === "image/jpg" || file.type === ""); // MIME. //
      return nameOk && typeOk; // Ok. //
    } // isJpgFile v√©ge. //

    function sortFiles(list) { // Sort. //
      if (!BEALLITAS.sortByName) return list; // Ha nem kell. //
      return list.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: "base" })); // Sort. //
    } // sortFiles v√©ge. //

    function filterFiles(list) { // Sz≈±r√©s. //
      return list.filter(isJpgFile); // JPG. //
    } // filterFiles v√©ge. //

    function setReadyState(ready) { // Start/Reset. //
      btnStart.disabled = !ready; // Start. //
      btnReset.disabled = !ready; // Reset. //
    } // setReadyState v√©ge. //

    function enableNavUi() { // Nav. //
      btnPrev.disabled = (currentIndex <= 0); // Prev. //
      btnNext.disabled = (currentIndex >= files.length - 1); // Next. //
    } // enableNavUi v√©ge. //

    function clampIndex(i) { // Clamp. //
      if (!files.length) return 0; // Nincs. //
      if (i < 0) return 0; // Min. //
      if (i >= files.length) return files.length - 1; // Max. //
      return i; // Ok. //
    } // clampIndex v√©ge. //

    function formatDate(d) { // D√°tum. //
      if (!d || !(d instanceof Date) || isNaN(d.getTime())) return "-"; // Nincs. //
      return d.toLocaleString(undefined, { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" }); // Format. //
    } // formatDate v√©ge. //

    function escapeHtml(s) { // Escape. //
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); // Escape. //
    } // escapeHtml v√©ge. //

    function normalizeCoord(x) { // Kerek√≠t√©s. //
      return Math.round(x * 100000) / 100000; // 5 tizedes. //
    } // normalizeCoord v√©ge. //

    function buildGoogleMapsLink(lat, lon) { // GMaps. //
      return `https://www.google.com/maps?q=${encodeURIComponent(`${lat},${lon}`)}`; // Link. //
    } // buildGoogleMapsLink v√©ge. //

    async function readExifForCurrent(file) { // EXIF olvas√°s. //
      try { // Try. //
        const data = await exifr.parse(file, { tiff: true, exif: true, gps: true }); // Parse. //
        return data || {}; // Vissza. //
      } catch { // Catch. //
        return {}; // √úres. //
      } // catch v√©ge. //
    } // readExifForCurrent v√©ge. //

    async function reverseGeocodeForCurrent(lat, lon, signal) { // Reverse geocode. //
      const nlat = normalizeCoord(lat); // Lat. //
      const nlon = normalizeCoord(lon); // Lon. //
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(nlat)}&lon=${encodeURIComponent(nlon)}`; // URL. //
      const res = await fetch(url, { method: "GET", headers: { "Accept": "application/json" }, signal }); // Fetch + abort. //
      if (!res.ok) throw new Error(`HTTP ${res.status}`); // Hiba. //
      const json = await res.json(); // JSON. //
      const place = (json && (json.name || json.display_name)) ? (json.name || json.display_name) : null; // Hely. //
      return place; // Vissza. //
    } // reverseGeocodeForCurrent v√©ge. //

    function updateDynamicMetaH() { // Meta magass√°g friss√≠t√©s. //
      const h = metaBar.getBoundingClientRect().height; // M√©r√©s. //
      document.documentElement.style.setProperty("--metaH", `${Math.ceil(h)}px`); // CSS v√°ltoz√≥. //
    } // updateDynamicMetaH v√©ge. //

    async function showImage(i) { // K√©p megjelen√≠t√©s. //
      if (!files.length) return; // Nincs. //

      activeViewToken += 1; // <<< √öJ TOKEN: ett≈ël kezdve csak ez √≠rhatja a UI-t >>> //
      const myToken = activeViewToken; // Token ment√©s. //

      if (activeGeoAbort) { try { activeGeoAbort.abort(); } catch {} } // <<< El≈ëz≈ë geocode megszak√≠t√°s >>> //
      activeGeoAbort = null; // Null√°z. //

      currentIndex = clampIndex(i); // Clamp. //
      setCounts(); // UI. //
      enableNavUi(); // Nav. //

      const file = files[currentIndex]; // Aktu√°lis f√°jl. //

      elFileName.textContent = file.name; // N√©v. //
      elTakenAt.textContent = "‚Ä¶"; // T√∂lt. //
      elPlace.textContent = "‚Ä¶"; // T√∂lt. //
      elGeoState.textContent = BEALLITAS.reverseGeocode ? "k√©szen" : "kikapcsolva"; // State. //

      updateDynamicMetaH(); // MetaH el≈ëzetes. //

      safeReleaseObjectUrl(); // URL eldob. //
      currentObjectUrl = URL.createObjectURL(file); // URL. //
      imgPhoto.src = currentObjectUrl; // K√©p. //

      const meta = await readExifForCurrent(file); // EXIF. //
      if (myToken !== activeViewToken) return; // <<< Ha k√∂zben tov√°bbl√©pt√©l: STOP >>> //

      const dt = meta.DateTimeOriginal || meta.CreateDate || meta.ModifyDate || meta.DateTimeDigitized || null; // D√°tum mez≈ëk. //
      const dateObj = (dt instanceof Date) ? dt : (dt ? new Date(dt) : null); // Date. //
      elTakenAt.textContent = formatDate(dateObj); // D√°tum. //

      const lat = meta.latitude; // Lat. //
      const lon = meta.longitude; // Lon. //

      if (typeof lat === "number" && typeof lon === "number") { // GPS van. //
        const nlat = normalizeCoord(lat); // Norm. //
        const nlon = normalizeCoord(lon); // Norm. //
        const gmaps = buildGoogleMapsLink(nlat, nlon); // Link. //

        if (!BEALLITAS.reverseGeocode) { // Ha nincs reverse. //
          elPlace.innerHTML = `${escapeHtml(`${nlat}, ${nlon}`)} ‚Ä¢ <a href="${gmaps}" target="_blank" rel="noopener">Google Maps</a>`; // Koord + link. //
          requestAnimationFrame(updateDynamicMetaH); // MetaH friss√≠t√©s. //
          return; // K√©sz. //
        } // reverse off v√©ge. //

        elGeoState.textContent = "lek√©r√©s‚Ä¶"; // State. //

        const ac = new AbortController(); // Abort controller. //
        activeGeoAbort = ac; // Akt√≠v ment√©se. //

        try { // Try. //
          const placeName = await reverseGeocodeForCurrent(nlat, nlon, ac.signal); // Reverse. //
          if (myToken !== activeViewToken) return; // <<< Ha k√∂zben tov√°bbl√©pt√©l: STOP >>> //

          elGeoState.textContent = placeName ? "ok" : "nincs"; // State. //

          if (placeName) { // Van hely. //
            elPlace.innerHTML = `<b>${escapeHtml(placeName)}</b> ‚Ä¢ <a href="${gmaps}" target="_blank" rel="noopener">Google Maps</a>`; // Hely + link. //
          } else { // Nincs. //
            elPlace.innerHTML = `${escapeHtml(`${nlat}, ${nlon}`)} ‚Ä¢ <a href="${gmaps}" target="_blank" rel="noopener">Google Maps</a>`; // Koord + link. //
          } // if v√©ge. //
        } catch (e) { // Catch. //
          if (myToken !== activeViewToken) return; // <<< Ha k√∂zben tov√°bbl√©pt√©l: STOP >>> //
          if (e && e.name === "AbortError") { // Abort. //
            elGeoState.textContent = "megszak√≠tva"; // State. //
          } else { // Egy√©b. //
            elGeoState.textContent = "hiba"; // State. //
            elPlace.innerHTML = `${escapeHtml(`${nlat}, ${nlon}`)} ‚Ä¢ <a href="${gmaps}" target="_blank" rel="noopener">Google Maps</a>`; // Fallback. //
          } // else v√©ge. //
        } finally { // Finally. //
          if (activeGeoAbort === ac) activeGeoAbort = null; // Csak akkor null√°z, ha ez volt az akt√≠v. //
          requestAnimationFrame(updateDynamicMetaH); // MetaH friss√≠t√©s. //
        } // try/catch v√©ge. //
      } else { // Nincs GPS. //
        elPlace.textContent = "Nincs GPS adat az EXIF-ben."; // Jelz√©s. //
        requestAnimationFrame(updateDynamicMetaH); // MetaH friss√≠t√©s. //
      } // GPS v√©ge. //
    } // showImage v√©ge. //

    async function startViewer() { // Ind√≠t√°s. //
      if (!files.length) { log("Nincs mit megjelen√≠teni ‚Äì v√°lassz mapp√°t!"); return; } // Nincs. //
      setup.style.display = "none"; // Setup el. //
      viewer.style.display = "block"; // Viewer be. //
      await showImage(0); // Els≈ë. //
    } // startViewer v√©ge. //

    function exitViewer() { // Kil√©p√©s. //
      if (activeGeoAbort) { try { activeGeoAbort.abort(); } catch {} } // Fut√≥ fetch stop. //
      activeGeoAbort = null; // Null. //
      viewer.style.display = "none"; // Viewer el. //
      setup.style.display = "grid"; // Setup be. //
      safeReleaseObjectUrl(); // URL eldob. //
      log("Visszal√©pt√©l a setup n√©zetre (Esc)."); // Log. //
    } // exitViewer v√©ge. //

    async function nextImage() { // K√∂vetkez≈ë. //
      if (!files.length) return; // Nincs. //
      if (currentIndex >= files.length - 1) return; // V√©g√©n. //
      await showImage(currentIndex + 1); // Next. //
    } // nextImage v√©ge. //

    async function prevImage() { // El≈ëz≈ë. //
      if (!files.length) return; // Nincs. //
      if (currentIndex <= 0) return; // Elej√©n. //
      await showImage(currentIndex - 1); // Prev. //
    } // prevImage v√©ge. //

    function resetAll() { // Reset. //
      if (activeGeoAbort) { try { activeGeoAbort.abort(); } catch {} } // Fut√≥ fetch stop. //
      activeGeoAbort = null; // Null. //
      activeViewToken += 1; // Token ugrik, √≠gy minden fut√≥ async ‚Äú√©rv√©nytelen‚Äù. //
      safeReleaseObjectUrl(); // URL eldob. //
      files = []; // √úres. //
      currentIndex = 0; // 0. //
      setCounts(); // UI. //
      setReadyState(false); // Gombok. //
      btnPrev.disabled = true; // Prev. //
      btnNext.disabled = true; // Next. //
      elGeoState.textContent = "-"; // State. //
      elFileName.textContent = "-"; // Meta. //
      elTakenAt.textContent = "-"; // Meta. //
      elPlace.textContent = "-"; // Meta. //
      log("Reset k√©sz. V√°lassz √∫j mapp√°t."); // Log. //
    } // resetAll v√©ge. //

    async function pickFolder() { // Pick. //
      resetAll(); // Tiszta. //
      if ("showDirectoryPicker" in window) { // API. //
        try { // Try. //
          log("Directory Picker: mappa kiv√°laszt√°sa‚Ä¶"); // Log. //
          const dirHandle = await window.showDirectoryPicker({ mode: "read" }); // Pick. //
          const temp = []; // Gy≈±jt≈ë. //
          for await (const entry of dirHandle.values()) { // Bej√°r√°s. //
            if (entry.kind === "file") temp.push(await entry.getFile()); // File. //
          } // for. //
          files = sortFiles(filterFiles(temp)); // Sz≈±r√©s+sort. //
          if (!files.length) { log("Nem tal√°ltam JPG k√©pet ebben a mapp√°ban."); setReadyState(false); return; } // Nincs. //
          setCounts(); // UI. //
          setReadyState(true); // Enged√©ly. //
          elGeoState.textContent = BEALLITAS.reverseGeocode ? "k√©szen" : "kikapcsolva"; // State. //
          log(`Beolvasva: ${files.length} db JPG. Kattints: ‚ÄúMegjelen√≠t√©s‚Äù.`); // Log. //
          return; // K√©sz. //
        } catch { // Catch. //
          log("Mappa kiv√°laszt√°sa megszak√≠tva. Fallback indul‚Ä¶"); // Log. //
        } // catch. //
      } // if. //
      log("Fallback: mappa kiv√°laszt√°sa (webkitdirectory)‚Ä¶"); // Log. //
      fallbackFolder.value = ""; // Reset. //
      fallbackFolder.click(); // Click. //
    } // pickFolder v√©ge. //

    fallbackFolder.addEventListener("change", () => { // Fallback change. //
      const list = Array.from(fallbackFolder.files || []); // Array. //
      files = sortFiles(filterFiles(list)); // Sz≈±r√©s+sort. //
      if (!files.length) { log("Fallback: nem tal√°ltam JPG k√©pet."); setReadyState(false); return; } // Nincs. //
      setCounts(); // UI. //
      setReadyState(true); // Enged√©ly. //
      elGeoState.textContent = BEALLITAS.reverseGeocode ? "k√©szen" : "kikapcsolva"; // State. //
      log(`Fallback beolvas√°s k√©sz: ${files.length} db JPG. Kattints: ‚ÄúMegjelen√≠t√©s‚Äù.`); // Log. //
    }); // listener. //

    btnPick.addEventListener("click", pickFolder); // Pick. //
    btnStart.addEventListener("click", startViewer); // Start. //
    btnReset.addEventListener("click", resetAll); // Reset. //

    btnNext.addEventListener("click", nextImage); // Next. //
    btnPrev.addEventListener("click", prevImage); // Prev. //
    imageWrap.addEventListener("click", () => { nextImage(); }); // Katt = next. //

    window.addEventListener("resize", () => { if (viewer.style.display !== "none") updateDynamicMetaH(); }); // Resize. //

    document.addEventListener("keydown", (e) => { // Key. //
      const inViewer = (viewer.style.display !== "none"); // Viewer-e. //
      if (!inViewer) return; // Ha nem. //
      if (e.key === "ArrowRight") { e.preventDefault(); nextImage(); } // Jobb. //
      else if (e.key === "ArrowLeft") { e.preventDefault(); prevImage(); } // Bal. //
      else if (e.key === " " || e.key === "Enter") { e.preventDefault(); nextImage(); } // Space/Enter. //
      else if (e.key === "Escape") { e.preventDefault(); exitViewer(); } // Esc. //
    }); // keydown. //

    log("FIX k√©sz: token + AbortController ‚Üí a helyadat mindig az aktu√°lis k√©pre tartozik, nem cs√∫szik el."); // Indul√≥ log. //
  </script> <!-- JS v√©ge. -->
</body> <!-- Body v√©ge. -->
</html> <!-- HTML v√©ge. -->
